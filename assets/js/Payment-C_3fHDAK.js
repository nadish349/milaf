import{j as e,a as t,d as s,e as a,_ as r}from"./index-jHmpFEMT.js";import{r as n}from"./vendor-CyyySG0f.js";import{H as o}from"./Header-BhIOcdD6.js";import{s as i,a as l}from"./PostalCodeAutocomplete-DBHDLA_4.js";import{m as d}from"./m1-DUCQGgOG.js";import{m as c,l as u}from"./firebase-rYhY7HPw.js";import{u as m}from"./router-Dpy7eVzN.js";import"./ui-D10HkiTw.js";import"./LoginForm-DeovXXO9.js";import"./card-CmKHpVHl.js";import"./label-DM97D0RX.js";const p=({value:t,onChange:s,placeholder:a="Enter zip code or address",className:r="",required:o=!1,onSuggestionSelect:d,fieldType:c="zipcode"})=>{const[u,m]=n.useState([]),[p,x]=n.useState(!1),[g,h]=n.useState(!1),y=n.useRef(null),b=n.useRef(null);return n.useEffect(()=>{const e=e=>{y.current&&!y.current.contains(e.target)&&b.current&&!b.current.contains(e.target)&&x(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),e.jsxs("div",{className:"relative",children:[e.jsx("input",{ref:y,type:"text",value:t,onChange:e=>{const t=e.target.value;if(s(t),t.length>=2){h(!0);const e=/^\d+$/.test(t);setTimeout(()=>{try{let s=[];s=e?i(t):l(t),m(s),x(s.length>0)}catch(s){m([]),x(!1)}finally{h(!1)}},100)}else m([]),x(!1),h(!1)},onFocus:()=>{u.length>0&&x(!0)},onBlur:e=>{setTimeout(()=>{b.current?.contains(document.activeElement)||x(!1)},200)},onKeyDown:e=>{"Escape"===e.key&&x(!1)},className:`w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 ${r}`,placeholder:a,required:o,autoComplete:"off"}),g&&e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2",children:e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-green-500"})}),p&&u.length>0&&e.jsx("div",{ref:b,className:"absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto",children:u.map((t,a)=>e.jsxs("div",{className:"px-3 py-2 hover:bg-green-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors duration-150",onClick:e=>{e.preventDefault(),e.stopPropagation(),(e=>{s("zipcode"===c?e.postcode.toString():`${e.suburb}, ${e.state}`),x(!1),m([]),d&&d(e)})(t)},onMouseDown:e=>{e.preventDefault()},children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.displayText}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"zipcode"===c?`Click to select postcode: ${t.postcode}`:`Click to select: ${t.suburb}, ${t.state}`})]},`${t.postcode}-${t.suburb}-${a}`))})]})},x=()=>{const{cartItems:i,getTotalPrice:l,getTotalItems:x}=t(),[g,h]=n.useState(""),[y,b]=n.useState({companyName:"",buyerName:"",contact:"",streetAddress:"",address:"",zipcode:""});n.useState(!1);const[f,j]=n.useState(!1),[v,N]=n.useState(!1),[w,S]=n.useState(""),[k,C]=n.useState([]),[P,z]=n.useState(null),[A,$]=n.useState(!1),[_,E]=n.useState(""),I=m();n.useEffect(()=>{s.currentUser&&L()},[]);const L=async()=>{try{const e=await c(u(a,"users",s.currentUser.uid));if(e.exists()){const t=e.data();b(e=>({...e,buyerName:t.displayName||"",contact:t.phone||"",streetAddress:t.streetAddress||"",address:t.address||"",zipcode:t.zipcode||""}))}}catch(e){}},T=(e,t)=>{b(s=>({...s,[e]:t}))};n.useEffect(()=>{(async()=>{if("australian-post"!==g)return C([]),z(null),void S("");if(y.zipcode)try{N(!0),S("");const e=await fetch(`http://localhost:4000/api/parcel/services?to_postcode=${encodeURIComponent(y.zipcode)}`),t=await e.json(),s=t?.services?.service||[];if(C(s),!Array.isArray(s)||0===s.length)return z(null),void S("No Australia Post services available for this postcode.");let a=s[0];for(const o of s){const e=Number(o.price),t=Number(a.price);!isNaN(e)&&(isNaN(t)||e<t)&&(a=o)}const r=await fetch(`http://localhost:4000/api/parcel/calc?to_postcode=${encodeURIComponent(y.zipcode)}&service_code=${encodeURIComponent(a.code)}`),n=await r.json();n?.error?(z(null),S(n.error)):(z(n?.postage_result||null),n?.postage_result?.total_cost&&localStorage.setItem("lastShippingCost",n.postage_result.total_cost),n?.postage_result?.delivery_time&&localStorage.setItem("deliveryTime",n.postage_result.delivery_time))}catch(e){S(e?.message||"Failed to fetch Australia Post quote."),z(null)}finally{N(!1)}})()},[g,y.zipcode]);return e.jsxs("div",{className:"min-h-screen",style:{backgroundImage:`url(${d})`,backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"},children:[e.jsx(o,{}),e.jsx("div",{className:"pt-12 pb-4 px-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx("button",{onClick:()=>{window.history.back()},className:"mb-2 w-8 h-8 rounded-full bg-white shadow-lg hover:bg-gray-100 transition-colors flex items-center justify-center text-gray-600 hover:text-gray-800",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("h1",{className:"text-3xl font-bold text-white mb-1",children:"Payment Details"}),e.jsx("p",{className:"text-white text-sm",children:"Complete your order with billing and delivery information"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-3",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-800 mb-3",children:"Billing Address"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-1",children:"Company Name"}),e.jsx("input",{type:"text",value:y.companyName,onChange:e=>T("companyName",e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200",placeholder:"Enter company name (optional)"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-1",children:"Buyer Name *"}),e.jsx("input",{type:"text",value:y.buyerName,onChange:e=>T("buyerName",e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200",placeholder:"Enter buyer name",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-1",children:"Contact Number *"}),e.jsx("input",{type:"tel",value:y.contact,onChange:e=>T("contact",e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200",placeholder:"Enter contact number",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-1",children:"Street Address *"}),e.jsx("input",{type:"text",value:y.streetAddress,onChange:e=>T("streetAddress",e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200",placeholder:"Enter street address",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-1",children:"Address *"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{type:"button",onClick:()=>{if(!navigator.geolocation)return void alert("Geolocation is not supported by this browser.");j(!0);navigator.geolocation.getCurrentPosition(async e=>{try{const{latitude:s,longitude:a,accuracy:r,altitude:n,heading:o,speed:i}=e.coords;let l="",d="";try{const e=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${a}&addressdetails=1&zoom=18&extratags=1&namedetails=1&accept-language=en`);if(e.ok){if(l=(await e.json()).display_name,d=l,null!=n){const e=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${a}&addressdetails=1&zoom=19&extratags=1&namedetails=1&accept-language=en`);if(e.ok){const t=await e.json();t.display_name&&t.display_name.length>l.length&&(d=t.display_name)}}}}catch(t){}if(d){b(e=>({...e,address:d}));let e="",t="";r<=5?(e="Ultra-High Accuracy Multi-Sensor",t="GPS + Wi-Fi + Cellular + Sensors"):r<=10?(e="High Accuracy Multi-Sensor",t="GPS + Wi-Fi + Cellular"):r<=25?(e="Good Accuracy Multi-Sensor",t="GPS + Wi-Fi"):r<=50?(e="Moderate Accuracy Multi-Sensor",t="GPS + Cellular"):(e="Basic GPS Accuracy",t="GPS Only");const n=`Location Retrieved Successfully!\n\nAccuracy: ${e}\nPrecision: ${Math.round(r)}m\nSensors Used: ${t}\nCoordinates: ${s.toFixed(6)}, ${a.toFixed(6)}\n\nAddress: ${d.substring(0,120)}${d.length>120?"...":""}`;alert(n)}else alert("Could not retrieve address from coordinates. Please enter manually.")}catch(t){alert("Error retrieving address. Please enter manually.")}finally{j(!1)}},e=>{let t="Could not get your precise location. ",s="";switch(e.code){case e.PERMISSION_DENIED:t+="Location permission denied.",s="\n\nTo enable precise location:\n1. Click the location icon in your browser\n2. Select 'Allow' for location access\n3. Enable GPS, Wi-Fi, and cellular location services";break;case e.POSITION_UNAVAILABLE:t+="Location information unavailable.",s="\n\nTry:\n1. Moving to an open area\n2. Enabling Wi-Fi and cellular data\n3. Waiting a few seconds for GPS lock";break;case e.TIMEOUT:t+="Location request timed out.",s="\n\nThis usually means:\n1. GPS is still acquiring satellites\n2. Wi-Fi positioning is slow\n3. Try again in a few seconds";break;default:t+="Unknown positioning error.",s="\n\nPlease try:\n1. Refreshing the page\n2. Checking your device location settings\n3. Entering address manually"}alert(t+s),j(!1)},{enableHighAccuracy:!0,timeout:2e4,maximumAge:0})},disabled:f,className:"w-full px-3 py-2 bg-blue-500 hover:bg-blue-600 disabled:bg-blue-300 text-white text-sm font-medium rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2",children:f?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Getting Multi-Sensor Location..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 11a3 3 0 11-6 0 3 3 0 016 0z"})]}),e.jsx("span",{children:"Get Current Location"})]})}),e.jsx(p,{value:y.address,onChange:e=>T("address",e),placeholder:"Enter address, suburb, or city name",fieldType:"address",required:!0,onSuggestionSelect:e=>{b(t=>({...t,zipcode:e.postcode.toString()}))}})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-1",children:"Zip Code *"}),e.jsx(p,{value:y.zipcode,onChange:e=>T("zipcode",e),placeholder:"Enter zip code or suburb name",fieldType:"zipcode",required:!0,onSuggestionSelect:e=>{b(t=>({...t,address:`${e.suburb}, ${e.state}`}))}})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-3",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-800 mb-3",children:"Delivery Options"}),e.jsx("div",{className:"space-y-2",children:[{id:"pickup",name:"Pick up from Warehouse",description:"Collect your order from our warehouse",estimatedDays:"Same day"},{id:"australian-post",name:"Australian Post",description:"Standard domestic shipping",estimatedDays:""}].map(t=>e.jsxs("div",{onClick:()=>h(t.id),className:"p-2 rounded-lg border-2 cursor-pointer transition-all duration-200 hover:shadow-md "+(g===t.id?"border-green-500 bg-green-50":"border-gray-200 hover:border-gray-300"),children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 rounded-full border-2 flex items-center justify-center "+(g===t.id?"border-green-500 bg-green-500":"border-gray-300"),children:g===t.id&&e.jsx("svg",{className:"w-2 h-2 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-800 text-sm",children:t.name}),e.jsx("p",{className:"text-xs text-gray-600",children:t.description}),t.estimatedDays&&e.jsxs("p",{className:"text-xs text-green-600 font-medium",children:["Estimated: ",t.estimatedDays]})]})]})})}),"australian-post"===t.id&&"australian-post"===g&&e.jsx("div",{className:"mt-2 p-2 rounded bg-white border border-dashed border-gray-300",children:v?e.jsx("p",{className:"text-xs text-gray-600",children:"Fetching Australia Post rates…"}):w?e.jsx("p",{className:"text-xs text-red-600",children:w}):P?e.jsxs("div",{className:"text-xs text-gray-700",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Service"}),e.jsx("span",{className:"font-semibold",children:P.service})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Shipping"}),e.jsxs("span",{className:"font-semibold",children:["$",P.total_cost]})]}),P.delivery_time&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Delivery Time"}),e.jsx("span",{className:"font-semibold",children:P.delivery_time})]})]}):e.jsx("p",{className:"text-xs text-gray-500",children:"Enter your zip code to see shipping rates."})})]},t.id))}),e.jsxs("div",{className:"mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700 mb-2",children:"Warehouse Address"}),e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:"Beverages will be dispatched from here"}),e.jsxs("div",{className:"text-xs text-gray-600",children:[e.jsx("p",{className:"font-medium",children:"Factory Warehouse Location"}),e.jsx("p",{children:"3/85 Alfred Street"}),e.jsx("p",{children:"Chipping Norton 2170 NSW Australia"})]})]}),e.jsxs("div",{className:"mt-4 p-3 bg-white rounded-lg border border-gray-200",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700 mb-3",children:"Order Summary"}),0===i.length?e.jsx("p",{className:"text-xs text-gray-500",children:"No items in cart"}):e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm text-gray-700",children:[e.jsx("span",{children:"Items"}),e.jsxs("span",{children:["$",l().toFixed(2)]})]}),"australian-post"===g&&P&&e.jsxs("div",{className:"flex justify-between text-sm text-gray-700",children:[e.jsx("span",{children:"Shipping"}),e.jsxs("span",{children:["$",P.total_cost]})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold text-gray-800 border-t pt-2",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:["$",(l()+("australian-post"===g&&P&&Number(P.total_cost)||0)).toFixed(2)]})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1 text-right",children:"* Final amount will be calculated with shipping at checkout"})]})]})]})]}),e.jsxs("div",{className:"flex flex-col items-end space-y-2",children:[e.jsx("button",{onClick:async()=>{try{$(!0),E("");const e="http://localhost:4000",t=await(s.currentUser?.getIdToken());if(!t)return void E("Please log in to continue with payment");localStorage.setItem("billingAddress",JSON.stringify(y)),localStorage.setItem("shippingMode",g);const{loadRazorpay:a,getPublicKey:n,createOrder:o,verifyPayment:l}=await r(async()=>{const{loadRazorpay:e,getPublicKey:t,createOrder:s,verifyPayment:a}=await import("./paymentService-Bm1qQ5Jc.js");return{loadRazorpay:e,getPublicKey:t,createOrder:s,verifyPayment:a}},[]);await a();const d=await n(e),c=await o(e,t,{cartItems:i,zipcode:y.zipcode});new window.Razorpay({key:d,amount:c.amount,currency:c.currency,order_id:c.orderId,name:"Milaf Cola Australia & NZ",description:"Order Payment",handler:async function(s){try{await l(e,t,s),alert("Payment successful!"),I("/checkpoint")}catch(a){E(a?.message||"Verification failed")}},prefill:{name:y.buyerName,contact:y.contact},notes:{zipcode:y.zipcode},theme:{color:"#10B981"}}).open()}catch(e){E(e?.message||"Payment initialization failed")}finally{$(!1)}},disabled:!y.buyerName||!y.contact||!y.streetAddress||!y.address||!y.zipcode||!g||A,className:"bg-green-400 hover:bg-green-300 disabled:from-gray-400 disabled:to-gray-500 disabled:cursor-not-allowed text-black font-bold text-base py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg w-full lg:w-auto",children:A?"Processing Payment...":"Pay with Razorpay"}),_&&e.jsx("div",{className:"text-sm text-red-600 text-right",children:_})]})]})})]})};export{x as Payment};
